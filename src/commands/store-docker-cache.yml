description: >
  This command generates docker cache key
parameters:
  key_docker:
    type: string
    default: docker-layer-caching-key-{{ checksum "/tmp/docker-layer-caching-key.txt" }}
    description: "Cache key"
  paths:
    type: string
    default: /tmp/docker-layer-caching-key.txt
    description: "Cache paths"
  LANGUAGE:
    type: string
    default: "python"
    description: "Language to use"
  DOCKERFILE_PATH:
    type: string
    default: "docker/Dockerfile"
    description: "Path to Dockerfile"
steps:
  - run:
      name: install skopeo
      command: <<include(scripts/install-skopeo.sh)>>
  - run:
      environment:
        LANGUAGE: <<parameters.LANGUAGE>>
        DOCKERFILE: <<parameters.DOCKERFILE_PATH>>
      name: docker cache key
      command: <<include(scripts/docker-cache.sh)>>
  - run:
      name: Calculate checksum of poetry.lock
      command: |
        if [ -f "poetry.lock" ]; then
          checksum=$(md5sum poetry.lock | awk '{print $1}')
        else
          checksum="none"
        fi
      environment:
        CHECKSUM_POETRY: $checksum
  - run:
      name: Calculate checksum of Gemfile.lock
      command: |
        if [ -f "Gemfile.lock" ]; then
          checksum=$(md5sum Gemfile.lock | awk '{print $1}')
        else
          checksum="none"
        fi
      environment:
        CHECKSUM_GEMFILE: $checksum
  - save_cache:
      key: <<parameters.key_docker>>
      paths:
        - <<parameters.paths>>
  - save_cache:
      key: <<parameters.key_docker>>-{{ env.CHECKSUM_POETRY }}-{{ env.CHECKSUM_GEMFILE }}
      paths:
        - <<parameters.paths>>
